<div class="comments">
<h2> Comments </h2>
{{$comments := dict}}
{{if getenv "NETLIFY" }}
  {{$comments = partialCached "netlifyCommentList.html" .}}
{{else}}
  {{$comments = partialCached "formspreeCommentList.html" .}}
{{end}}

{{range (index $comments .RelPermalink)}}
<div class="comment">
  <img width="100" height="100" 
    alt="{{.name}} Avatar" 
    {{ with resources.GetRemote (print 
      "https://www.gravatar.com/avatar/"
      (md5 .email) "?s=100&d=wavatar") }}
      {{ with Err. }}
        {{warnf "%s" .}}
      {{ else }} 
      src="{{ . RelPermalink }}"
      {{ end }}
    {{ end }}>
  <div class="author">{{.name}}</div>
  <div class="message">{{.message}}</div>
</div>
{{end}}
{{ if .Disabled  }}
  <div>
    Comments have been disabled by the website administrator.
  </div>
{{ else }}
  {{if getenv "NETLIFY" }}
    <form netlify name="Comments">
  {{ else }}
    <form action="https://formspree.io/f/{{.FormspreeCommentForm}}" method="post">
  {{ end }}
  <input type="hidden" name="url" value="{{.RelPermalink}}">
    <div>
      <label for="name">Name:</label>
      <input id="name" name="name" type="text" required>
    </div>
    <div>
      <label for="email">Email:</label>
      <input id="email" name="email" type="email" required>
    </div>
    <div>
      <label for="message">Comment:</label>
      <textarea id="message" name="message" cols="50" rows="10" required></textarea>
    </div>
    <div>
      <button type="submit">Send</button>
    </div>
  </form>
  {{end}}
</div>